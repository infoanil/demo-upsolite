{%- assign initial_v = product.selected_or_first_available_variant -%}
{%- assign recharge_plans = shop.metaobjects.recharge_plans.values -%}
{%- capture plan_meta_json -%}{%- endcapture -%}
{%- for plan in recharge_plans -%}
  {%- if forloop.index0 > 0 -%}
    {%- capture plan_meta_json -%}{{ plan_meta_json }},{%- endcapture -%}
  {%- endif -%}
  {%- capture plan_meta_json -%}
    {{ plan_meta_json }}
    {{ plan.name | json }}: {
      "tagline": {{ plan.tagline | default: '' | json }},
      "hide": {{ plan.hide_plan | default: false | json }}
    }
  {%- endcapture -%}
{%- endfor -%}

<script type="application/json" id="sp-data-{{ product.id }}">
{%- capture by_variant_json -%}{%- endcapture -%}
{%- capture variant_meta_json -%}{%- endcapture -%}

{%- for vv in product.variants -%}
    {%- if forloop.index0 > 0 -%}
    {%- capture by_variant_json -%}{{ by_variant_json }},{%- endcapture -%}
    {%- capture variant_meta_json -%}{{ variant_meta_json }},{%- endcapture -%}
    {%- endif -%}

    {%- capture variant_meta_json -%}
    {{ variant_meta_json }}
    "{{ vv.id }}": {
      "title": {{ vv.title | json }},
      "price": {{ vv.price | default: 0 }},
      "compare_at_price": {%- if vv.compare_at_price -%}{{ vv.compare_at_price }}{%- else -%}null{%- endif -%}
    }
  {%- endcapture -%}

    {%- capture by_variant_json -%}
    {{ by_variant_json }}
    "{{ vv.id }}": [
      {%- assign wrote_one = false -%}
    {%- for alloc in vv.selling_plan_allocations -%}
    {%- assign sp_name = alloc.selling_plan.name | to_s -%}
    {%- assign sp_price = alloc.price | default: 0 -%}
    {%- if sp_name != '6 month subscription' or sp_price != 0 -%}
        {%- assign cmp = alloc.compare_at_price | default: 0 -%}
        {%- assign prc = sp_price -%}

        {%- if wrote_one -%},{%- endif -%}
          {
            "selling_plan_group_id": {{ alloc.selling_plan_group_id | json }},
            "price_adjustments": [
              {%- for pa in alloc.price_adjustments -%}
                    {%- assign pa_pos = pa.position | default: forloop.index -%}
                    {%- assign pa_val = pa.value | default: pa.price | default: 0 -%}
                    { "position": {{ pa_pos }}, "value": {{ pa_val }} }{%- unless forloop.last -%},{%- endunless -%}
            {%- endfor -%}
            ],
            "selling_plan": {
              "id": {{ alloc.selling_plan.id | json }},
              "name": {{ alloc.selling_plan.name | json }},
              "options": {{ alloc.selling_plan.options | json }},
              "compare_price": {{ cmp }},
              "price": {{ prc }}
            }
          }
          {%- assign wrote_one = true -%}
        {%- endif -%}
    {%- endfor -%}
    ]
  {%- endcapture -%}
    {%- endfor -%}

{
  "groups": {{ product.selling_plan_groups | json }},
  "byVariant": { {{ by_variant_json }} },
  "initialVariantId": "{{ initial_v.id }}",
  "variantMeta": { {{ variant_meta_json }} },
  "planMeta": { {{ plan_meta_json }} }
}
</script>


<script type="application/json" id="money-format">
{
  "currency": {{ shop.currency | json }},
  "locale": {{ request.locale.iso_code | json }}
}
</script>

<recharge-custom-block
        class="rcb"
        product-id="{{ product.id }}"
        form-selector="form[action*='/cart/add']"
        one-time-option="{% if product.requires_selling_plan %}false{% else %}true{% endif %}"
>
    <div class="rcb-container">
        <input type="hidden" name="selling_plan" class="rcb__hidden-input">
        <div class="rcb__banner">SAVE ON EVERY ORDER</div>

        <!-- Subscribe card -->
        <div class="rcb__card rcb__card--subscribe">
            <label class="rcb__row rcb__row--radio">
                <input type="radio" name="rcb_mode_{{ product.id }}" class="rcb__radio rcb__radio--sub" value="subscription">
                <span class="rcb__title">Subscribe &amp; Save</span>
                <div class="rcb__price">
                    <s class="rcb__price-compare" aria-hidden="true"></s>
                    <span class="rcb__price-now"></span>
                </div>
            </label>

            <ul class="rcb__benefits" hidden>
                <li data-sub-discount>Save on your subscription - our best price</li>
                <li>FREE shipping on every subscription</li>
                <li data-frequency-message data-prefix="Convenient autoship every">Convenient autoship every 30 days</li>
                <li>Adjust flavors, shipments, or cancel anytime</li>
                <li data-extra-feature></li>
            </ul>

            <div class="rcb__controls" hidden>
                <label class="rcb__label" for="rcb-frequency-{{ product.id }}">Deliver every:</label>
                <div class="rcb__select-wrap">
                    <select id="rcb-frequency-{{ product.id }}" class="rcb__select"></select>
                    <svg class="rcb__chev" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M7 10l5 5 5-5" fill="none" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
            </div>
        </div>

        <!-- One-time row -->
        {% unless product.requires_selling_plan %}
            <div class="rcb__card rcb__card--onetime">
                <label class="rcb__row rcb__row--radio">
                    <input type="radio" name="rcb_mode_{{ product.id }}" class="rcb__radio rcb__radio--ot" value="onetime">
                    <span class="rcb__title">One-time Purchase</span>
                    <div class="rcb__price">
                        <span class="rcb__ot-price"></span>
                    </div>
                </label>
            </div>
        {% endunless %}
    </div>

</recharge-custom-block>

<script>
    class RechargeCustomBlock extends HTMLElement {
        connectedCallback() {
            this.productId = this.getAttribute('product-id');
            this.formSelector = this.getAttribute('form-selector') || "form[action*='/cart/add']";
            this.showOneTime = (this.getAttribute('one-time-option') || 'true') === 'true';
            this.featureMessage = '';

            const dataEl = document.getElementById(`sp-data-${this.productId}`);
            if (!dataEl) return this._error('Missing plan JSON');
            this.data = JSON.parse(dataEl.innerHTML || '{}');
            this.groups = this.data.groups || [];
            this.byVariant = this.data.byVariant || {};
            this.variantMeta = this.data.variantMeta || {};
            this.planMeta = this.data.planMeta || {};
            this.currentVid = String(this.data.initialVariantId || '');

            const mf = document.getElementById('money-format');
            this.moneyMeta = mf ? JSON.parse(mf.textContent || '{}') : {};

            this.form = this.closest(this.formSelector) || document.querySelector(this.formSelector);
            if (!this.form) return this._error('Product form not found');

            // cache nodes
            this.subRadio = this.querySelector('.rcb__radio--sub');
            this.otRadio  = this.querySelector('.rcb__radio--ot');
            this.controls = this.querySelector('.rcb__controls');
            this.benefits = this.querySelector('.rcb__benefits');
            this.freq     = this.querySelector('.rcb__select');
            this.priceNow = this.querySelector('.rcb__price-now');
            this.priceCmp = this.querySelector('.rcb__price-compare');
            this.otPrice  = this.querySelector('.rcb__ot-price');
            this.frequencyBenefit = this.querySelector('[data-frequency-message]');
            this.frequencyPrefix = this.frequencyBenefit?.dataset.prefix?.trim() || '';
            this.defaultFrequencyText = this.frequencyBenefit?.textContent.trim() || '';
            this.extraFeature = this.querySelector('[data-extra-feature]');
            this.defaultFeatureText = this.extraFeature?.textContent.trim() || '';

            // events
            this.subRadio.addEventListener('change', () => this._applyMode());
            if (this.otRadio) {
                this.otRadio.addEventListener('change',  () => this._applyMode());
            }
            this.freq.addEventListener('change',     () => this._setSellingPlan(this.freq.value || ''));

            // first render
            this.refreshForVariant(this.currentVid);

            // variant switches (buttons/inputs with data-variant-id)
            document.addEventListener('change', (e) => {
                const pressed = e.target?.closest('[data-variant-id]');
                if (!pressed) return;
                const vid = String(pressed.getAttribute('data-variant-id'));
                if (vid) this.refreshForVariant(vid);
            });
        }

        _error(msg){ this.innerHTML = `<div class="rcb__error">${msg}</div>`; }

        _formatMoney(cents){
            const val = Number(cents||0)/100;
            try {
                return new Intl.NumberFormat(
                    this.moneyMeta.locale || 'en',
                    { style:'currency', currency:this.moneyMeta.currency || 'USD' }
                ).format(val);
            } catch(_) { return val.toFixed(2); }
        }

        _setSellingPlan(value){
            this.form.querySelectorAll('[name="selling_plan"]').forEach(i => i.value = value || '');
            this.featureMessage = this._resolveFeatureMessage(value) || this.defaultFeatureText || '';
            this.changeExtraFeatureText();
            this._updatePricing(value);
        }

        _updatePricing(selectedPlanId = ''){
            const allocs = this.byVariant[this.currentVid] || [];
            const planId = selectedPlanId ? String(selectedPlanId) : '';
            let subPrice = null;
            let cmpPrice = null;
            let planForMessage = null;

            if (planId && this.allocsByPlan && this.allocsByPlan[planId]){
                const alloc = this.allocsByPlan[planId];
                const plan = alloc?.selling_plan || {};
                planForMessage = plan;
                if (typeof plan.price === 'number') subPrice = plan.price;
                if (typeof plan.compare_price === 'number' && plan.compare_price > 0){
                    cmpPrice = plan.compare_price;
                }
            } else {
                planForMessage = allocs[0]?.selling_plan || null;
                allocs.forEach(a => {
                    const plan = a?.selling_plan || {};
                    const planPrice = Number(plan.price);
                    const planCompare = Number(plan.compare_price);
                    if (isFinite(planPrice)){
                        subPrice = (subPrice === null) ? planPrice : Math.min(subPrice, planPrice);
                    }
                    if (cmpPrice === null && isFinite(planCompare) && planCompare > 0){
                        cmpPrice = planCompare;
                    }
                });
            }

            const varMeta = this.variantMeta[this.currentVid] || {};
            this.priceNow.textContent = subPrice != null ? this._formatMoney(subPrice) : '';

            if (this.otPrice) {
                let oneTime = (typeof varMeta.price === 'number') ? varMeta.price : null;
                if (oneTime === null) oneTime = cmpPrice != null ? cmpPrice : subPrice;
                this.otPrice.textContent = oneTime != null ? this._formatMoney(oneTime) : '';
            }

            if (cmpPrice != null && subPrice != null && cmpPrice > subPrice){
                this.priceCmp.textContent = this._formatMoney(cmpPrice);
                this.priceCmp.style.display = '';
            } else {
                this.priceCmp.textContent = '';
                this.priceCmp.style.display = 'none';
            }

            const discountEl = this.querySelector?.('[data-sub-discount]') || document.querySelector('[data-sub-discount]');
            if (discountEl) {
                const cmp = Number(cmpPrice);
                const sub = Number(subPrice);
                const pct = (isFinite(cmp) && isFinite(sub) && cmp > 0 && sub >= 0 && sub < cmp)
                    ? Math.round(((cmp - sub) / cmp) * 100)
                    : 0;
                if (pct > 0) {
                    discountEl.textContent = `Save ${pct}% on your subscription — our best price`;
                    discountEl.classList.remove('hidden');
                } else {
                    discountEl.classList.add('hidden');
                }
            }
            this._updateFrequencyMessage(planForMessage, selectedPlanId);
        }

        _updateFrequencyMessage(plan, selectedPlanId = ''){
            if (!this.frequencyBenefit) return;
            const defaultText = this.defaultFrequencyText;
            const prefix = this.frequencyPrefix;

            let frequency = this._extractFrequency(plan);
            if (!frequency) {
                frequency = this._extractFrequencyFromGroup(selectedPlanId);
            }

            if (frequency) {
                this.frequencyBenefit.textContent = prefix
                    ? `${prefix} ${frequency}`.trim()
                    : frequency;
            } else if (defaultText) {
                this.frequencyBenefit.textContent = defaultText;
            }
        }

        _extractFrequency(plan){
            if (!plan) return '';
            const options = Array.isArray(plan.options) ? plan.options : [];
            const freqOption = options.find(opt => (opt?.name || '').toLowerCase() === 'order frequency and unit');
            const raw = freqOption?.value || (Array.isArray(freqOption?.values) ? freqOption.values[0] : '');
            return this._normalizeFrequency(raw);
        }

        _extractFrequencyFromGroup(selectedPlanId = ''){
            const allocs = this.byVariant[this.currentVid] || [];
            const planId = selectedPlanId ? String(selectedPlanId) : '';
            let groupId = '';

            if (planId && this.allocsByPlan && this.allocsByPlan[planId]) {
                groupId = String(this.allocsByPlan[planId]?.selling_plan_group_id || '');
            }

            if (!groupId && allocs.length) {
                groupId = String(allocs[0]?.selling_plan_group_id || '');
            }

            if (!groupId) return '';

            const group = this.groups.find(g => String(g.id) === groupId);
            if (!group) return '';

            const freqOpt = (group.options || []).find(opt => (opt?.name || '').toLowerCase() === 'order frequency and unit');
            const raw = Array.isArray(freqOpt?.values) ? freqOpt.values[0] : freqOpt?.value;
            return this._normalizeFrequency(raw);
        }

        _resolveFeatureMessage(selectedPlanId = ''){
            if (!this.planMeta) return '';
            const planId = selectedPlanId ? String(selectedPlanId) : '';

            let planName = '';
            if (planId && this.allocsByPlan && this.allocsByPlan[planId]) {
                planName = this.allocsByPlan[planId]?.selling_plan?.name || '';
            }

            if (!planName) {
                const allocs = this.byVariant[this.currentVid] || [];
                planName = allocs[0]?.selling_plan?.name || '';
            }

            planName = (planName || '').trim();
            if (!planName) return '';
            const meta = this.planMeta[planName];
            const tagline = meta?.tagline;
            return (typeof tagline === 'string') ? tagline.trim() : '';
        }

        _normalizeFrequency(value){
            if (!value) return '';
            let cleaned = String(value).trim();
            if (!cleaned) return '';

            cleaned = cleaned.replace(/[_-]+/g, ' ').replace(/\s+/g, ' ');
            const match = cleaned.match(/^(\d+(?:\.\d+)?)\s*(\w+)$/);
            if (!match) return cleaned;

            const qtyRaw = match[1];
            const qtyNum = Number(qtyRaw);
            const unitRaw = (match[2] || '').toLowerCase();
            const singularMap = { day: 'day', days: 'day', week: 'week', weeks: 'week', month: 'month', months: 'month', year: 'year', years: 'year' };
            const pluralMap = { day: 'days', week: 'weeks', month: 'months', year: 'years' };

            const unitSingular = singularMap[unitRaw] || unitRaw;
            const qtyStr = Number.isFinite(qtyNum) && Number.isInteger(qtyNum) ? String(qtyNum) : qtyRaw;

            if (Number.isFinite(qtyNum) && Math.abs(qtyNum - 1) < 1e-9) {
                return `1 ${unitSingular}`;
            }

            const unitPlural = pluralMap[unitSingular] || (unitSingular.endsWith('s') ? unitSingular : `${unitSingular}s`);
            return `${qtyStr} ${unitPlural}`;
        }

        _applyMode(){
            if (this.subRadio.checked){
                this.controls.hidden = false;
                this.benefits.hidden = false;
                this._setSellingPlan(this.freq.value || '');
            } else {
                this.controls.hidden = true;
                this.benefits.hidden = true;
                this._setSellingPlan('');
            }
        }

        changeExtraFeatureText(text = '') {
            const featureContainer = this.extraFeature || this.querySelector('.rcb__benefits [data-extra-feature]');
            if (!featureContainer) return;
            const resolved = text || this.featureMessage || this.defaultFeatureText || '';
            featureContainer.textContent = resolved;
            featureContainer.classList.toggle('hidden', !resolved);
        }

        refreshForVariant(variantId){
            this.currentVid = String(variantId || '');
            const allocs = this.byVariant[this.currentVid] || [];
            this.allocsByPlan = {};

            // reset
            this.freq.innerHTML = '';
            this._setSellingPlan('');

            // if no subs for this variant → force one-time
            if (!allocs.length){
                this.subRadio.checked = false;
                this.subRadio.disabled = true;
                if (this.showOneTime && this.otRadio){
                    this.otRadio.checked = true;
                    this.otRadio.disabled = false;
                }
                this.controls.hidden = true;
                this.benefits.hidden = true;
            } else {
                // populate frequency options (ordered by group)
                const byGroup = {};
                allocs.forEach(a => {
                    (byGroup[a.selling_plan_group_id] ||= []).push(a);
                    const planId = String(a?.selling_plan?.id || '');
                    if (planId) this.allocsByPlan[planId] = a;
                });

                this.groups.forEach(group => {
                    (byGroup[group.id] || []).forEach(a => {
                        const opt = document.createElement('option');
                        opt.value = String(a.selling_plan.id);
                        const label = (Array.isArray(a.selling_plan.options) && a.selling_plan.options[0]?.value)
                            ? `${a.selling_plan.name} - ${a.selling_plan.id}`
                            : (a.selling_plan.name || 'Plan');
                        opt.textContent = `${label} – ${this._formatMoney(a.selling_plan.price)}`;
                        this.freq.appendChild(opt);
                    });
                });

                this.subRadio.disabled = false;
                if (this.otRadio) {
                    this.otRadio.disabled = !this.showOneTime;
                }

                // default to Subscribe selected (matches screenshot)
                this.subRadio.checked = true;
                this.controls.hidden = false;
                this.benefits.hidden = false;
                this._setSellingPlan(this.freq.value || '');
            }

            // ensure selling_plan reflects chosen mode
            this._applyMode();
        }
    }
    customElements.define('recharge-custom-block', RechargeCustomBlock);
</script>

<style>
    .rcb{font-family:inherit;color:#0a0a0a;}
    .rcb-container{margin-bottom: 16px;}
    .rcb *{box-sizing:border-box}
    .rcb__banner{background:#111;color:#fff;font-weight:600;text-align:center;padding:.65rem 1rem;border-radius:8px 8px 0 0}
    .rcb__card{border:1px solid #111;border-radius:0 0 8px 8px;padding:1rem;background:#fff}
    .rcb__card--onetime{margin-top:1rem;border-radius:8px}
    .rcb__row{display:flex;align-items:center;gap:.75rem}
    .rcb__row--radio{justify-content:space-between}
    .rcb__radio{width:20px;height:20px;accent-color:#0a0a0a}
    .rcb__title{font-weight:700;flex:1;margin-left:.5rem}
    .rcb__price{display:flex;align-items:center;gap:.5rem;white-space:nowrap}
    .rcb__price-compare{opacity:.6}
    .rcb__benefits{margin:1rem 0 0 2rem;padding:0;list-style:none}
    .rcb__benefits li{position:relative;margin:.5rem 0;padding-left:1.5rem}
    .rcb__benefits li::before{content:"✓";position:absolute;left:0;top:0}
    .rcb__controls{margin-top:1rem}
    .rcb__label{display:block;margin-bottom:.25rem;font-weight:600}
    .rcb__select-wrap{position:relative}
    .rcb__select{width:100%;padding:.6rem .9rem;border:1px solid #cfd4d9;border-radius:6px;appearance:none}
    .rcb__chev{position:absolute;right:.55rem;top:50%;transform:translateY(-50%);width:18px;height:18px;pointer-events:none}
</style>
